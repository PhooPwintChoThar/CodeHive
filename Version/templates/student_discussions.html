<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CodeHive - Discussions</title>
    <link rel="stylesheet" href="{{url_for('static', path='styles.css')}}">
  </head>
  <body>
    <div class="header">
      <div class="header-content">
        <div class="brand">
          CodeHive
          <img src="{{url_for('static', path='test4.png')}}" alt="CodeHive" width="40" height="35" />
        </div>
        <div class="tab" style="display: flex; flex: 1; justify-content: center; align-items: center;">
          <span style="margin: 0 40px">
            <a href="/student/{{id}}/quizzes" class="btn btn-tabs" style="font-size: 16px">Quiz</a>
          </span>
          <span style="margin: 0 40px">
            <a href="/student/{{id}}/discussions" class="btn btn-tabs" style="font-size: 16px">Discussion</a>
          </span>
          <span style="margin: 0 40px">
            <a href="/student/{{id}}/courses" class="btn btn-tabs" style="font-size: 16px">Courses</a>
          </span>
        </div>
        <a href="/" class="loginandout" style="font-size: 16px">Logout</a>
      </div>
    </div>

    <div class="container">
      <div class="content">
        <h2 class="section-title">Study Discussions</h2>
        <button class="btn btn-primary" style="margin-bottom: 20px" onclick="openNewDiscussionModal()">
          + New Discussion
        </button>
        
        <div class="discussion-list">
          {% for discussion in discussions %}
          <div class="discussion-card">
            <div class="discussion-post">
              <div class="post-header">
                <span class="post-author">{{ discussion.student.name }}</span>
                <div style="display: flex; align-items: center; gap: 15px;">
                  <span class="post-time">{{ discussion.timestamp.strftime('%B %d, %Y at %I:%M %p') }}</span>
                  {% if discussion.student.id == id %}
                  <div class="dropdown">
                    <button class="dropdown-btn" onclick="toggleDropdown(this)">‚ãÆ</button>
                    <div class="dropdown-content">
                      <a href="#" onclick="openEditModal({{ discussion.id }}, '{{ discussion.topic }}', '{{ discussion.message }}'); return false;">Edit</a>
                      <form method="POST" action="/student/{{id}}/discussion/{{ discussion.id }}/delete" style="margin: 0;">
                        <button type="submit" class="dropdown-delete" onclick="return confirm('Are you sure you want to delete this discussion?')">Delete</button>
                      </form>
                    </div>
                  </div>
                  {% endif %}
                </div>
              </div>
              <h3 style="color: var(--primary); margin-bottom: 10px; font-size: 18px;">{{ discussion.topic }}</h3>
              <div class="post-content">{{ discussion.message }}</div>
              
              <div class="post-actions">
                <span class="post-action like-btn" onclick="toggleLike(this, {{id}}, {{ discussion.id }})" data-likes="{{ discussion.like_counts }}">
                  üëç <span class="like-count">{{ discussion.like_counts }}</span> Likes
                </span>
                <span class="post-action reply-btn" onclick="toggleReply(this)">
                  üí¨ {{ discussion.comment|length }} Comments
                </span>
              </div>
              
              <!-- Comments Section -->
              {% if discussion.comment %}
              <div class="comments-list" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                {% for comment_student, comment_content in discussion.comment.items() %}
                <div class="comment-item" style="background: #f9f9f9; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                    <strong style="color: var(--secondary);">{{ comment_student.name }}</strong>
                    {% if comment_student.id == id %}
                    <form method="POST" action="/student/{{id}}/discussion/{{ discussion.id }}/comment/delete" style="margin: 0;">
                      <input type="hidden" name="comment_student_id" value="{{ comment_student.id }}">
                      <button type="submit" class="btn-delete-comment" onclick="return confirm('Delete this comment?')">üóëÔ∏è</button>
                    </form>
                    {% endif %}
                  </div>
                  <div style="color: #333;">{{ comment_content }}</div>
                </div>
                {% endfor %}
              </div>
              {% endif %}
              
              <!-- Reply Section -->
              <div class="reply-section">
                <form method="POST" action="/student/{{id}}/discussion/{{ discussion.id }}/comment">
                  <textarea class="reply-input" name="content" placeholder="Write your comment..." required></textarea>
                  <div class="reply-actions">
                    <button type="button" class="btn-small btn-cancel" onclick="toggleReply(this.closest('.discussion-card').querySelector('.reply-btn'))">
                      Cancel
                    </button>
                    <button type="submit" class="btn-small btn-reply-submit">Comment</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- New Discussion Modal -->
    <div id="newDiscussionModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">New Discussion</h3>
          <button class="close-btn" onclick="closeNewDiscussionModal()">&times;</button>
        </div>
        <form method="POST" action="/student/{{id}}/discussion/new">
          <div class="form-group">
            <label class="form-label">Discussion Topic</label>
            <input type="text" name="topic" class="form-input" placeholder="What would you like to discuss?" required />
          </div>
          <div class="form-group">
            <label class="form-label">Your Message</label>
            <textarea name="message" class="form-textarea" placeholder="Share your thoughts..." required></textarea>
          </div>
          <button type="submit" class="btn btn-primary">Post Discussion</button>
        </form>
      </div>
    </div>

    <!-- Edit Discussion Modal -->
    <div id="editDiscussionModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Edit Discussion</h3>
          <button class="close-btn" onclick="closeEditModal()">&times;</button>
        </div>
        <form id="editForm" method="POST">
          <div class="form-group">
            <label class="form-label">Discussion Topic</label>
            <input type="text" id="editTopic" name="topic" class="form-input" required />
          </div>
          <div class="form-group">
            <label class="form-label">Your Message</label>
            <textarea id="editMessage" name="message" class="form-textarea" required></textarea>
          </div>
          <button type="submit" class="btn btn-primary">Update Discussion</button>
        </form>
      </div>
    </div>

    <script>
      function openNewDiscussionModal() {
        document.getElementById("newDiscussionModal").classList.add("active");
      }

      function closeNewDiscussionModal() {
        document.getElementById("newDiscussionModal").classList.remove("active");
      }

      function openEditModal(discussionId, topic, message) {
        document.getElementById("editDiscussionModal").classList.add("active");
        document.getElementById("editForm").action = `/student/{{id}}/discussion/${discussionId}/edit`;
        document.getElementById("editTopic").value = topic;
        document.getElementById("editMessage").value = message;
      }

      function closeEditModal() {
        document.getElementById("editDiscussionModal").classList.remove("active");
      }

      function toggleDropdown(button) {
        const dropdown = button.nextElementSibling;
        dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function closeDropdown(e) {
          if (!button.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.style.display = 'none';
            document.removeEventListener('click', closeDropdown);
          }
        });
      }

      async function toggleLike(element, studentId, discussionId) {
        const likeCountSpan = element.querySelector(".like-count");
        let currentLikes = parseInt(likeCountSpan.textContent);
        const isLiked = element.classList.contains("liked");

        try {
          const url = isLiked 
            ? `/student/${studentId}/discussion/${discussionId}/dislike`
            : `/student/${studentId}/discussion/${discussionId}/like`;
          
          const response = await fetch(url, { method: 'POST' });
          const data = await response.json();
          
          likeCountSpan.textContent = data.likes;
          element.classList.toggle("liked");
        } catch (error) {
          console.error('Error toggling like:', error);
        }
      }

      function toggleReply(button) {
        const card = button.closest(".discussion-card");
        const replySection = card.querySelector(".reply-section");
        replySection.classList.toggle("active");

        if (!replySection.classList.contains("active")) {
          replySection.querySelector(".reply-input").value = "";
        }
      }
    </script>
  </body>
</html>