<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>EduHub - AI Tutor</title>
<link rel="stylesheet" href="{{url_for('static', path='styles.css')}}" />
<style>
  .chat-container {
    display: flex;
    flex-direction: column;
    height: 600px;
    background-color: white;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
    overflow: hidden;
  }

  .chat-header {
    padding: 20px;
    background-color: #f5f5f5;
    border-bottom: 1px solid #e0e0e0;
    font-size: 16px;
    font-weight: 600;
    color: #333;
  }

  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  .message {
    display: flex;
    margin-bottom: 10px;
    animation: slideIn 0.3s ease-in;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .message-user {
    justify-content: flex-end;
  }

  .message-ai {
    justify-content: flex-start;
  }

  .message-content {
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 8px;
    word-wrap: break-word;
    line-height: 1.5;
    font-size: 14px;
  }

  .message-user .message-content {
    background-color: var(--primary);
    color: white;
    border-bottom-right-radius: 2px;
  }

  .message-ai .message-content {
    background-color: #f0f0f0;
    color: #333;
    border-bottom-left-radius: 2px;
  }

  .chat-input-area {
    display: flex;
    gap: 10px;
    padding: 15px 20px;
    background-color: #f9f9f9;
    border-top: 1px solid #e0e0e0;
  }

  .chat-input {
    flex: 1;
    padding: 12px 15px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
    font-family: inherit;
  }

  .chat-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(61, 90, 128, 0.1);
  }

  .chat-submit-btn {
    padding: 12px 25px;
    background-color: var(--primary);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
  }

  .chat-submit-btn:hover {
    background-color: #2c4562;
  }

  .chat-submit-btn:active {
    transform: scale(0.98);
  }

  .back-btn {
    display: inline-block;
    margin-bottom: 20px;
    padding: 10px 20px;
    background-color: var(--primary);
    color: white;
    text-decoration: none;
    border-radius: 5px;
    transition: all 0.3s;
  }

  .back-btn:hover {
    background-color: #2c4562;
  }

  .loading-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #666;
    font-size: 14px;
  }

  .loading-dots {
    display: inline-flex;
    gap: 4px;
  }

  .loading-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: #666;
    animation: bounce 1.4s infinite;
  }

  .loading-dot:nth-child(2) {
    animation-delay: 0.2s;
  }

  .loading-dot:nth-child(3) {
    animation-delay: 0.4s;
  }

  @keyframes bounce {
    0%, 80%, 100% {
      opacity: 0.5;
      transform: translateY(0);
    }
    40% {
      opacity: 1;
      transform: translateY(-10px);
    }
  }

  .empty-chat {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #999;
    text-align: center;
  }

  .empty-chat-icon {
    font-size: 48px;
    margin-bottom: 15px;
  }
</style>
</head>
<body>
<div class="header">
<div class="header-content">
<div class="brand">
          CodeHive
<img
src="{{url_for('static', path='test4.png')}}"
alt="CodeHive"
width="40"
height="35"
 />
</div>
<div
class="tab"
style="
            display: flex;
            flex: 1;
            justify-content: center;
            align-items: center;
          "
>
<span style="margin: 0 40px">
<a
href="/student/{{id}}/quizzes"
class="btn btn-tabs"
style="font-size: 16px"
>Quiz</a
>
</span>
<span style="margin: 0 40px">
<a
href="/student/{{id}}/discussions"
class="btn btn-tabs"
style="font-size: 16px"
>Discussion</a
>
</span>
<span style="margin: 0 40px">
<a
href="/student/{{id}}/courses"
class="btn btn-tabs"
style="font-size: 16px"
>Courses</a
>
</span>
<span style="margin: 0 40px">
<a
href="/student/{{id}}/profile"
class="btn btn-tabs"
style="font-size: 16px"
>Profile</a
>
</span>
</div>
<a href="/" class="loginandout" style="font-size: 16px">Logout</a>
</div>
</div>
<div class="container">
<div class="content">
<a href="/student/{{id}}/courses" class="back-btn"
>‚Üê Back to Courses</a
>
<h2 class="section-title" id="chatCourseName">{{course.name}}</h2>
<div class="chat-container">
<div class="chat-header">Ask me anything about your {{course.name}} course</div>
<div class="chat-messages" id="chatMessages">
{% if history %}
  {% for msg in history %}
    {% if msg["role"] == "TA"%}
      <div class="message message-ai">
        <div class="message-content">{{msg["content"]}}</div>
      </div>
    {%else%}
      <div class="message message-user">
        <div class="message-content">{{msg["content"]}}</div>
      </div>
    {%endif%}
  {% endfor %}
{% else %}
  <div class="empty-chat">
    <div class="empty-chat-icon">üí¨</div>
    <p>Start a conversation! Ask anything about this course.</p>
  </div>
{% endif %}
</div>

<form id="chatForm" style="display: none;"></form>

<div class="chat-input-area">
  <input
    type="text"
    class="chat-input"
    id="chatInput"
    placeholder="Type your question..."
  />
  <button class="chat-submit-btn" onclick="sendMessage()" type="button">
    Send
  </button>
</div>
</div>
</div>
</div>

<script>
const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const studentId = {{id}};
const chatId = {{chatid}};

function sendMessage() {
  const question = chatInput.value.trim();
  
  if (!question) return;
  
  // Remove empty chat message if it exists
  const emptyChat = document.querySelector('.empty-chat');
  if (emptyChat) {
    emptyChat.remove();
  }
  
  // Show user message immediately
  appendMessage('user', question);
  chatInput.value = '';
  
  // Show loading indicator
  const loadingDiv = document.createElement('div');
  loadingDiv.className = 'message message-ai';
  loadingDiv.innerHTML = `
    <div class="message-content">
      <div class="loading-indicator">
        <span>AI Tutor is thinking</span>
        <div class="loading-dots">
          <div class="loading-dot"></div>
          <div class="loading-dot"></div>
          <div class="loading-dot"></div>
        </div>
      </div>
    </div>
  `;
  chatMessages.appendChild(loadingDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
  
  // Send to backend
  fetch(`/student/${studentId}/chat/${chatId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: new URLSearchParams({
      question: question
    })
  })
  .then(response => {
    if (response.ok) {
      // Remove loading indicator
      loadingDiv.remove();
      
      // Reload the page to show the new messages
      location.reload();
    } else {
      loadingDiv.remove();
      appendMessage('ai', 'Sorry, there was an error processing your request. Please try again.');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    loadingDiv.remove();
    appendMessage('ai', 'Sorry, there was an error sending your message. Please try again.');
  });
}

function appendMessage(role, content) {
  const messageDiv = document.createElement('div');
  messageDiv.className = `message message-${role === 'user' ? 'user' : 'ai'}`;
  
  const messageContent = document.createElement('div');
  messageContent.className = 'message-content';
  messageContent.textContent = content;
  
  messageDiv.appendChild(messageContent);
  chatMessages.appendChild(messageDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Allow Enter key to send message
chatInput.addEventListener('keypress', function(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

// Scroll to bottom on load
window.addEventListener('load', function() {
  chatMessages.scrollTop = chatMessages.scrollHeight;
});
</script>
</body>
</html>